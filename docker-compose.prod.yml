services:
    backend-prod:
        build:
            context: .
            target: runner # Apunta explícitamente a la etapa final de producción
            args:
                - PORT=${PORT:-5050}
        container_name: inventario-backend-prod
        restart: unless-stopped
        env_file:
            - ./.env.prod # Usamos el archivo estándar .env
        ports:
            - '${PORT:-5050}:${PORT:-5050}' # Usa 5050 si PORT no está definido en el host
        environment:
            - NODE_ENV=production
        depends_on: # Se asegura de que las dependencias se inicien primero
            - postgres-prod
            - redis-prod
            - rabbitmq-prod
        deploy:
            resources:
                limits:
                    cpus: '0.50' # Limita el uso de CPU al 50%
                    memory: 512M # Limita la memoria a 512MB
                reservations:
                    cpus: '0.25' # Reserva al menos el 25% de CPU
                    memory: 256M # Reserva al menos 256MB de memoria

    nginx:
        image: nginx:latest
        container_name: inventory-proxy
        restart: always
        ports:
            - '80:80'
            - '443:443'
        volumes:
            # Montas tu configuración de Nginx personalizada
            - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
            # Montas los certificados que obtengas (ej. con Certbot)
            - ./certbot/conf:/etc/letsencrypt
        depends_on:
            - backend-prod

    postgres-prod:
        image: postgres:16-alpine
        restart: always
        container_name: postgres-prod
        env_file: .env.prod
        ports:
            - '5430:5432'
        volumes:
            - ./postgres_data_prod:/var/lib/postgresql/data

    redis-prod:
        image: redis:latest
        restart: always
        container_name: redis-prod
        env_file:
            - path: ./.env.prod
        ports:
            - '${REDIS_PORT:-6379}:6379'
        environment:
            - REDIS_PASSWORD=${REDIS_PASSWORD:-Man12345.}
            - TZ=America/Caracas
        volumes:
            - ./redis_data_prod:/data
        command: sh -c "redis-server --requirepass $$REDIS_PASSWORD --appendonly yes"

    rabbitmq-prod:
        container_name: rabbitmq-prod
        image: 'rabbitmq:latest'
        restart: unless-stopped
        ports:
            - '5672:5672'
            - '15672:15672'
        environment:
            - RABBITMQ_DEFAULT_USER=appadmin
            - RABBITMQ_DEFAULT_PASS=Man12345.
