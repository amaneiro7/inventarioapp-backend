FROM node:22-alpine3.20 AS base
ENV DIR /app
WORKDIR $DIR

# Instalamos pnpm de forma nativa con Corepack
RUN corepack enable && corepack prepare pnpm@latest --activate

# --- Etapa 2: Deps (Instalación de todo) ---
FROM base AS deps
# Instalamos dependencias de sistema solo aquí
COPY package.json pnpm-lock.yaml* ./
# Instalamos dependencias de sistema solo aquí
RUN pnpm config set node-linker hoisted && \
    npm pkg delete scripts.prepare
# Instalamos TODO (incluye devDeps para el build)
RUN pnpm install --frozen-lockfile || pnpm install
    
    # --- Etapa 3: Build ---
FROM base AS builder
COPY --from=deps $DIR/node_modules ./node_modules
COPY tsconfig*.json .
COPY . .
# Ejecuta el script de build
RUN npm pkg delete scripts.prepare
RUN pnpm run build
RUN pnpm prune --prod

# --- Etapa 4: Runner (Imagen Final) ---
FROM base AS runner
ENV NODE_ENV=production
# 1. Crear la carpeta de logs y dar permisos (COMO ROOT)
RUN mkdir -p $DIR/logs && chown -R node:node $DIR
# Instalamos dumb-init solo en la imagen final
RUN apk add --no-cache dumb-init=1.2.5-r3

# Copiamos node_modules de producción y la carpeta dist compilada
COPY --from=builder $DIR/package.json .
COPY --from=builder $DIR/node_modules ./node_modules
COPY --from=builder $DIR/dist ./dist


USER $USER

EXPOSE $PORT
# Ejecutamos directamente con node
CMD [ "dumb-init", "node", "dist/src/apps/start.js" ]